{% extends "base.html" %}

{% block title %}Level 6 - Race Condition{% endblock %}

{% block content %}
<div class="level-container">
    <div class="level-header">
        <h2>‚ö° Level 6: Race Condition</h2>
        <div class="level-info">
            <span class="difficulty">{{ level_info.difficulty }}</span>
            <span class="points">{{ level_info.points }} points</span>
            <span class="hints">Hints: {{ hints_available }}/{{ level_info.hints }}</span>
        </div>
    </div>

    <div class="level-description">
        <p>You've reached the final subsystem - the flag store. The system has a vulnerability 
        that allows you to buy flags, but there's a catch with the timing...</p>
        
        <div class="hint-section">
            <button onclick="showHint({{ level }})" class="hint-button" {% if hints_available == 0 %}disabled{% endif %}>
                üí° Get Hint (-10 points)
            </button>
            <span class="hint-count">{{ hints_available }} hints remaining</span>
        </div>
    </div>

    <div class="flag-store">
        <div class="panel-header">
            <h3>üè™ Flag Store</h3>
            <p>Purchase your final flag to complete the mission</p>
        </div>
        
        <div class="store-info">
            <div class="balance-display">
                <h4>üí∞ Current Balance:</h4>
                <span class="balance-amount" id="balance-display">{{ balance }}p</span>
                <button onclick="updateBalance()" class="refresh-btn">üîÑ Refresh</button>
            </div>
            
            <div class="flag-item">
                <div class="flag-details">
                    <h4>üèÅ Final Flag</h4>
                    <p class="flag-description">The ultimate prize for completing all challenges</p>
                    <p class="flag-price">Price: <strong>100p</strong></p>
                </div>
                <button onclick="buyFlag()" class="buy-button" {% if balance < 100 %}disabled{% endif %}>
                    {% if balance >= 100 %}
                        üõí Buy Flag (100p)
                    {% else %}
                        üí∏ Insufficient Funds
                    {% endif %}
                </button>
            </div>
        </div>

        <div class="race-condition-info">
            <h4>üîç Race Condition Vulnerability</h4>
            <p>This system has a <strong>Time-of-Check to Time-of-Use (TOCTOU)</strong> vulnerability. 
            The balance check and purchase are not atomic operations.</p>
            
            <div class="vulnerability-details">
                <h5>How it works:</h5>
                <ol>
                    <li>System checks if you have enough balance (‚â•100p)</li>
                    <li>If yes, it waits a moment before processing</li>
                    <li>Then it deducts the balance and gives you the flag</li>
                    <li>But what if you can make multiple requests simultaneously?</li>
                </ol>
            </div>
        </div>

        <div class="parallel-attack">
            <h4>‚ö° Parallel Attack Tools</h4>
            <p>Use these tools to exploit the race condition:</p>
            
            <div class="attack-buttons">
                <button onclick="parallelAttack(2)" class="attack-btn">2 Parallel Requests</button>
                <button onclick="parallelAttack(3)" class="attack-btn">3 Parallel Requests</button>
                <button onclick="parallelAttack(5)" class="attack-btn">5 Parallel Requests</button>
                <button onclick="parallelAttack(10)" class="attack-btn">10 Parallel Requests</button>
            </div>
            
            <div class="attack-status" id="attackStatus" style="display: none;">
                <h5>üöÄ Attack Progress:</h5>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="status-text" id="statusText">Preparing attack...</div>
            </div>
        </div>

        <div class="curl-examples">
            <h4>üîß Manual Attack with curl</h4>
            <p>You can also use curl to send multiple requests simultaneously:</p>
            
            <div class="curl-command">
                <code>curl -X POST http://localhost:5000/race/buy -d "session_id=YOUR_SESSION" &</code>
                <span class="command-desc">Send request in background</span>
            </div>
            
            <div class="curl-command">
                <code>for i in {1..5}; do curl -X POST http://localhost:5000/race/buy -d "session_id=YOUR_SESSION" & done; wait</code>
                <span class="command-desc">Send 5 parallel requests</span>
            </div>
        </div>
    </div>

    <div class="flag-submission">
        <h4>üîë Submit the Flag</h4>
        <p>Once you've obtained the flag through the race condition, submit it to complete the mission:</p>
        
        <form method="POST" action="{{ url_for('level_submit', level=level) }}" class="flag-form">
            <div class="form-group">
                <label for="code">Flag:</label>
                <input type="text" id="code" name="code" placeholder="Enter the flag..." required>
            </div>
            <button type="submit" class="submit-button">Submit Flag</button>
        </form>

        {% if error %}
        <div class="error-message">
            <span class="error-icon">‚ùå</span>
            {{ error }}
        </div>
        {% endif %}
    </div>

    <div class="level-tips">
        <h4>üí° Investigation Tips:</h4>
        <ul>
            <li>Race conditions occur when multiple operations happen simultaneously</li>
            <li>Use the parallel attack buttons to send multiple requests at once</li>
            <li>Try different numbers of parallel requests to find the sweet spot</li>
            <li>The system has a built-in delay that makes the vulnerability exploitable</li>
            <li>You can also use curl or other tools to send parallel requests</li>
        </ul>
    </div>

    <div class="race-hint">
        <h4>üîç Investigation Note:</h4>
        <p><em>"Time is of the essence"</em></p>
        <p>Speed and timing are crucial. Multiple simultaneous requests can bypass the balance check!</p>
    </div>
</div>

<script>
function updateBalance() {
    fetch('/race/balance')
        .then(response => response.json())
        .then(data => {
            document.getElementById('balance-display').textContent = data.balance + 'p';
            
            // Update buy button state
            const buyButton = document.querySelector('.buy-button');
            if (data.balance >= 100) {
                buyButton.disabled = false;
                buyButton.textContent = 'üõí Buy Flag (100p)';
            } else {
                buyButton.disabled = true;
                buyButton.textContent = 'üí∏ Insufficient Funds';
            }
        })
        .catch(error => {
            console.error('Error updating balance:', error);
        });
}

function buyFlag() {
    fetch('/race/buy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`üéâ Flag purchased successfully!\nFlag: ${data.flag}\nNew balance: ${data.balance}p`);
            updateBalance();
        } else {
            alert('‚ùå Purchase failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error during purchase');
    });
}

function parallelAttack(count) {
    const statusDiv = document.getElementById('attackStatus');
    const progressFill = document.getElementById('progressFill');
    const statusText = document.getElementById('statusText');
    
    statusDiv.style.display = 'block';
    statusText.textContent = `Sending ${count} parallel requests...`;
    
    let completed = 0;
    const promises = [];
    
    for (let i = 0; i < count; i++) {
        const promise = fetch('/race/buy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            completed++;
            progressFill.style.width = (completed / count * 100) + '%';
            
            if (data.success) {
                if (data.level_completed) {
                    // Level 6 completed! Redirect to completion page
                    statusText.textContent = `üéâ Level 6 completed! Flag: ${data.flag}`;
                    setTimeout(() => {
                        window.location.href = '/complete';
                    }, 2000);
                    return data;
                } else {
                    statusText.textContent = `üéâ Success! Flag: ${data.flag}`;
                    updateBalance();
                    return data;
                }
            } else {
                statusText.textContent = `Attempt ${completed}: ${data.error}`;
                return null;
            }
        })
        .catch(error => {
            completed++;
            progressFill.style.width = (completed / count * 100) + '%';
            statusText.textContent = `Attempt ${completed}: Error`;
            return null;
        });
        
        promises.push(promise);
    }
    
    Promise.all(promises).then(results => {
        const success = results.filter(r => r !== null);
        if (success.length > 0) {
            statusText.textContent = `üéâ Attack successful! ${success.length} flag(s) obtained`;
        } else {
            statusText.textContent = '‚ùå Attack failed. Try with more requests or different timing.';
        }
    });
}

// Auto-update balance every 5 seconds
setInterval(updateBalance, 5000);

function resetBalance() {
    fetch('/race/reset', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`üîÑ Balance reset to ${data.balance}p`);
            updateBalance();
        } else {
            alert('‚ùå Reset failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error during reset');
    });
}

function manualComplete() {
    fetch('/race/complete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Level 6 completed manually!');
            window.location.href = '/complete';
        } else {
            alert('‚ùå Manual completion failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error during manual completion');
    });
}
</script>

<style>
.flag-store {
    background: #1a1a1a;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
}

.store-info {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 20px;
    margin: 20px 0;
}

.balance-display {
    background: #2a2a2a;
    padding: 20px;
    border-radius: 6px;
    text-align: center;
}

.balance-amount {
    display: block;
    font-size: 2em;
    font-weight: bold;
    color: #00ff41;
    margin: 10px 0;
    font-family: 'Share Tech Mono', monospace;
}

.refresh-btn {
    background: #ff6b35;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.flag-item {
    background: #2a2a2a;
    padding: 20px;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.flag-details h4 {
    margin: 0 0 10px 0;
    color: #00ff41;
}

.flag-price {
    color: #ff6b35;
    font-size: 1.2em;
    margin: 10px 0;
}

.buy-button {
    background: #00ff41;
    color: #000;
    border: none;
    padding: 15px 30px;
    border-radius: 6px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.buy-button:hover:not(:disabled) {
    background: #00cc33;
    transform: translateY(-2px);
}

.buy-button:disabled {
    background: #666;
    cursor: not-allowed;
    transform: none;
}

.race-condition-info {
    background: #2a2a2a;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
    border-left: 4px solid #ff6b35;
}

.vulnerability-details ol {
    margin: 15px 0;
    padding-left: 20px;
}

.vulnerability-details li {
    margin: 8px 0;
    color: #ccc;
}

.parallel-attack {
    margin: 20px 0;
}

.attack-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 15px 0;
}

.attack-btn {
    background: #ff6b35;
    color: #fff;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.attack-btn:hover {
    background: #ff5722;
    transform: translateY(-2px);
}

.reset-btn, .complete-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    margin: 5px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.reset-btn:hover {
    background: #218838;
    transform: translateY(-2px);
}

.complete-btn:hover {
    background: #218838;
    transform: translateY(-2px);
}

.attack-status {
    background: #1a1a1a;
    padding: 20px;
    border-radius: 6px;
    margin: 15px 0;
    border-left: 4px solid #00ff41;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: #333;
    border-radius: 10px;
    overflow: hidden;
    margin: 15px 0;
}

.progress-fill {
    height: 100%;
    background: #00ff41;
    width: 0%;
    transition: width 0.3s ease;
}

.status-text {
    font-family: 'Share Tech Mono', monospace;
    color: #00ff41;
    margin-top: 10px;
}

.curl-examples {
    background: #2a2a2a;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
}

.curl-command {
    background: #000;
    padding: 15px;
    border-radius: 6px;
    margin: 15px 0;
    border-left: 4px solid #00ff41;
}

.curl-command code {
    display: block;
    color: #00ff41;
    font-family: 'Share Tech Mono', monospace;
    margin-bottom: 8px;
    word-break: break-all;
}

.command-desc {
    color: #ccc;
    font-size: 14px;
}

.flag-submission {
    background: #1a1a1a;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
    border-left: 4px solid #00ff41;
}

.race-hint {
    background: #2a2a2a;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid #ff6b35;
}
</style>
{% endblock %}
